image: node:8

stages:
  - build
  - test
  - deploy

variables:
  DOCKER_DRIVER: overlay

before_script:
  - 'cd /srv/nodejs'
  - 'rm -rf cat-ui'
  - 'git clone git@gitlab.ximalaya.com:HIFE/cat-ui.git'
  - 'cd cat-ui'

deploy:
  stage: deploy
  script:
    - git checkout .
    - git checkout v1
    - git clean -fd
    - git pull origin v1
    - git status
    - npm run storybook:publish
    - >-
        curl https://oapi.dingtalk.com/robot/send?access_token=257e8078e3a47afad431421818bfe6fa7ff37d5c91f594ef1b06506520e5b6b6
        -H 'Content-Type: application/json'
        -d '{"msgtype": "markdown",
            "markdown": {
                "title":"cat-ui-storybook发布完成",
                "text":"commit msg: '"$CI_COMMIT_TITLE"' \n\n cat-ui-storybook发布完成 \n\n  [点击查看发布状态](http://gitlab.ximalaya.com/HIFE/cat-ui/-/jobs/'"$CI_JOB_ID"') \n\n [直接访问styleguidist环境](http://test.himalaya.com/catui/) "
            }
          }
        '

  environment:
    name: master
    url: http://test.himalaya.com
  only:
    - v1
  tags:
    - fe-common
